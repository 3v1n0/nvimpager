#!/bin/sh

# If we are not on a tty just "be" cat.
if [ ! -t 1 ]; then
  exec cat "$@"
fi

RUNTIME=${0%/*}
export RUNTIME
# TODO see what option less provides

file=
if [ $# -eq 0 -o ! -t 0 ]; then
  file=$(mktemp)
  trap 'rm -f "$file"' TERM QUIT HUP
  cat > "$file"
  set -- "$file"
fi
LINES=${LINES:-$(tput lines)}
if [ "$(cat "$@" | wc -l)" -le $LINES ]; then
  folder=${0%/*}
  folder=${folder:+$folder/}
  script=${0##*/}
  script=${script//pager/cat}
  "$folder$script" "$@" </dev/tty
  exit
fi

rc=~/.config/nvim/pagerrc.vim
if [ ! -r "$rc" ]; then
  rc=NORC
fi

nvim \
  -u "$rc" \
  --cmd 'set rtp^=$RUNTIME' \
  --cmd 'call pager#start()' \
  -c 'call pager#start2()' \
  "$@"
