#!/bin/bash

name=nvimpager
version=0.1

if [ "$1" = -v ]; then
  echo "$name $version"
  exit
fi

# If we are not on a tty just "be" cat.
if [[ ! -t 1 ]]; then
  exec cat "$@"
fi

RUNTIME=${0%/*}
export RUNTIME
# TODO see what option less provides

rc=~/.config/nvim/pagerrc.vim
if [[ ! -r "$rc" ]]; then
  rc=NORC
fi

files=()
options=()
for arg in "$@"; do
  if [[ -f "$arg" ]]; then
    files+=("$arg")
  else
    options+=("$arg")
  fi
done

if [[ ${#files} -eq 0 || ! -t 0 ]]; then
  files=($(mktemp))
  trap 'rm -f "$files"' TERM QUIT HUP INT EXIT
  cat > "$files"
fi

default_args=(
  -R
  -u "$rc"
  --cmd 'set rtp^=$RUNTIME'
  --cmd 'call pager#start()'
  -c 'call pager#start2()'
)
LINES=${LINES:-$(tput lines)}
if [[ "$(cat "${files[@]}" | wc -l)" -le $LINES ]]; then
  # Save the current process ID to enable the nvim process to write to our
  # stdout via the proc filesystem.
  PID=$$
  export PID
  nvim \
    "${default_args[@]}" \
    -c 'call cat#prepare()' \
    "${options[@]}" "${files[@]}" \
    >/dev/null
else
  nvim "${default_args[@]}" "${options[@]}" "${files[@]}"
fi
