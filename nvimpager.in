#!/bin/sh

# If we are not on a tty just "be" cat.
if [ ! -t 1 ]; then
  exec cat "$@"
fi

RUNTIME=${0%/*}
export RUNTIME
# TODO see what option less provides

rc=~/.config/nvim/pagerrc.vim
if [ ! -r "$rc" ]; then
  rc=NORC
fi

file=
if [ $# -eq 0 -o ! -t 0 ]; then
  file=$(mktemp)
  trap 'rm -f "$file"' TERM QUIT HUP INT EXIT
  cat > "$file"
  set -- "$file"
fi

LINES=${LINES:-$(tput lines)}
if [ "$(cat "$@" | wc -l)" -le $LINES ]; then
  # Save the current process ID to enable the nvim process to write to our
  # stdout via the proc filesystem.
  PID=$$
  export PID
  nvim \
    -R \
    -u "$rc" \
    --cmd 'set rtp^=$RUNTIME' \
    --cmd 'call pager#start()' \
    -c 'call pager#start2()' \
    -c 'call cat#prepare()' \
    "$@" \
    >/dev/null
else
  nvim \
    -u "$rc" \
    --cmd 'set rtp^=$RUNTIME' \
    --cmd 'call pager#start()' \
    -c 'call pager#start2()' \
    "$@"
fi
